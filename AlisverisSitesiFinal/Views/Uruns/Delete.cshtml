@model AlisverisSitesiFinal.Models.Urun
@using System
@using System.IO

@{
    ViewData["Title"] = "Ürünü Sil";

    // --- Mevcut ek görselleri bul (ana görselle aynı klasör + ad kökü) ---
    var gallery = new List<string>();
    if (!string.IsNullOrWhiteSpace(Model?.ResimUrl))
    {
        try
        {
            var wwwroot = System.IO.Path.Combine(System.AppContext.BaseDirectory, "..", "wwwroot");
            wwwroot = System.IO.Path.GetFullPath(wwwroot);

            var fiziksel = System.IO.Path.Combine(
                wwwroot,
                Model.ResimUrl.TrimStart('/').Replace("/", System.IO.Path.DirectorySeparatorChar.ToString())
            );

            var dir = System.IO.Path.GetDirectoryName(fiziksel);
            var stem = System.IO.Path.GetFileNameWithoutExtension(fiziksel);

            if (!string.IsNullOrEmpty(dir) && System.IO.Directory.Exists(dir))
            {
                var files = System.IO.Directory.GetFiles(dir)
                    .Where(p =>
                    {
                        var name = System.IO.Path.GetFileNameWithoutExtension(p);
                        if (name.Equals(stem, StringComparison.OrdinalIgnoreCase)) return false;
                        return name.StartsWith(stem + "_", StringComparison.OrdinalIgnoreCase)
                            || name.StartsWith(stem + "-", StringComparison.OrdinalIgnoreCase)
                            || name.StartsWith(stem + ".", StringComparison.OrdinalIgnoreCase);
                    })
                    .OrderBy(p => p)
                    .Take(24)
                    .Select(p =>
                    {
                        var rel = System.IO.Path.GetRelativePath(wwwroot, p).Replace("\\", "/");
                        return "/" + rel.TrimStart('/');
                    })
                    .ToList();

                gallery.AddRange(files);
            }
        }
        catch { /* dosya erişiminde sorun olursa sessiz geç */ }
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

<div class="container py-4">
    <h2 class="mb-3 text-danger">Ürünü Sil</h2>

    <div class="alert alert-warning shadow-sm">
        Bu ürünü silmek istediğinize emin misiniz? Bu işlem geri alınamaz.
        @* İpucu: Controller tarafında dosya temizliği yapıyorsanız ana/ek görseller de silinecektir. *@
    </div>

    <dl class="row">
        <dt class="col-sm-3">Ad</dt>
        <dd class="col-sm-9">@Model?.Ad</dd>

        <dt class="col-sm-3">Açıklama</dt>
        <dd class="col-sm-9">@Model?.Aciklama</dd>

        <dt class="col-sm-3">Fiyat</dt>
        <dd class="col-sm-9">@((Model?.Fiyat ?? 0).ToString("C"))</dd>

        <dt class="col-sm-3">Stok</dt>
        <dd class="col-sm-9">@Model?.StokAdedi</dd>

        <dt class="col-sm-3">Kategori</dt>
        <dd class="col-sm-9">@Model?.Kategori?.Ad</dd>

        <dt class="col-sm-3">Ana Görsel</dt>
        <dd class="col-sm-9">
            <img src="@(string.IsNullOrWhiteSpace(Model?.ResimUrl) ? Url.Content("~/images/placeholders/no-image.png") : Model!.ResimUrl)"
                 alt="@Model?.Ad" class="img-fluid rounded border"
                 style="max-height:200px;object-fit:contain;background:#fff;" />
        </dd>

        @if (gallery.Any())
        {
            <dt class="col-sm-3">Ek Görseller</dt>
            <dd class="col-sm-9">
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var g in gallery)
                    {
                        <div class="border rounded" style="width:92px;height:92px;overflow:hidden;background:#fff;">
                            <img src="@g" alt="ek" style="width:100%;height:100%;object-fit:cover;" />
                        </div>
                    }
                </div>
                <small class="text-muted d-block mt-1">Bu görseller ana görselle aynı klasörde tutulur.</small>
            </dd>
        }
    </dl>

    <form asp-action="DeleteConfirmed" method="post" class="mt-3">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash3 me-1"></i> Sil
            </button>
            <a asp-action="Index" class="btn btn-outline-secondary">İptal</a>
        </div>
    </form>
</div>
