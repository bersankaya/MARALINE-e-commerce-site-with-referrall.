@using Microsoft.AspNetCore.Mvc.Rendering
@using System.IO
@model AlisverisSitesiFinal.Models.Urun
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env

@{
    ViewData["Title"] = "Ürün Düzenle";
    var kategoriler = ViewBag.Kategoriler as SelectList; // controller'da set ediliyor

    // --- Mevcut ek görselleri bul (ana görsel ile aynı klasör + ad kökü) ---
    var gallery = new List<string>();
    if (!string.IsNullOrWhiteSpace(Model?.ResimUrl))
    {
        try
        {
            // wwwroot yolunu güvenli çöz
            var wwwroot = string.IsNullOrWhiteSpace(Env?.WebRootPath)
                ? System.IO.Path.Combine(Directory.GetCurrentDirectory(), "wwwroot")
                : Env!.WebRootPath;

            var fiziksel = System.IO.Path.Combine(
                wwwroot,
                Model.ResimUrl.TrimStart('/').Replace("/", System.IO.Path.DirectorySeparatorChar.ToString())
            );

            var dir = System.IO.Path.GetDirectoryName(fiziksel);
            var stem = System.IO.Path.GetFileNameWithoutExtension(fiziksel);

            if (!string.IsNullOrEmpty(dir) && System.IO.Directory.Exists(dir))
            {
                var files = System.IO.Directory.GetFiles(dir)
                    .Where(p =>
                    {
                        var name = System.IO.Path.GetFileNameWithoutExtension(p);
                        if (name.Equals(stem, StringComparison.OrdinalIgnoreCase)) return false;
                        return name.StartsWith(stem + "_", StringComparison.OrdinalIgnoreCase)
                            || name.StartsWith(stem + "-", StringComparison.OrdinalIgnoreCase)
                            || name.StartsWith(stem + ".", StringComparison.OrdinalIgnoreCase);
                    })
                    .OrderBy(p => p)
                    .Take(24)
                    .Select(p =>
                    {
                        var rel = System.IO.Path.GetRelativePath(wwwroot, p).Replace("\\", "/");
                        return "/" + rel.TrimStart('/');
                    })
                    .ToList();

                gallery.AddRange(files);
            }
        }
        catch { /* erişim hatası olursa sessiz geç */ }
    }
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

<div class="container py-4">
    <h1 class="h5 fw-bold mb-3">Ürün Düzenle</h1>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" class="card border-0 shadow-sm rounded-4" id="urunEditForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />

        <div class="card-body p-4">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

            <div class="row g-3">
                <!-- SOL SÜTUN -->
                <div class="col-12 col-lg-8">
                    <div class="mb-3">
                        <label asp-for="Ad" class="form-label">Ürün Adı</label>
                        <input asp-for="Ad" class="form-control" />
                        <span asp-validation-for="Ad" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Aciklama" class="form-label">Açıklama</label>
                        <textarea asp-for="Aciklama" class="form-control" rows="5"></textarea>
                        <span asp-validation-for="Aciklama" class="text-danger small"></span>
                    </div>

                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label asp-for="KategoriId" class="form-label">Kategori</label>
                            <select asp-for="KategoriId" asp-items="kategoriler" class="form-select">
                                <option value="">Kategori Seçin</option>
                            </select>
                            <span asp-validation-for="KategoriId" class="text-danger small"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label asp-for="StokAdedi" class="form-label">Stok</label>
                            <input asp-for="StokAdedi" class="form-control" inputmode="numeric" />
                            <span asp-validation-for="StokAdedi" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-12 col-md-6">
                            <label asp-for="FiyatAdmin" class="form-label">Admin Fiyatı</label>
                            <!-- Ondalık ayracı normalize etmek için text + inputmode -->
                            <input asp-for="FiyatAdmin" class="form-control" type="text" inputmode="decimal" autocomplete="off" />
                            <span asp-validation-for="FiyatAdmin" class="text-danger small"></span>
                            <div class="form-text">Admin fiyatı set edilince ürün yayınlanabilir.</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check form-switch mt-4 pt-2">
                                <input class="form-check-input" asp-for="YayindaMi" />
                                <label class="form-check-label" asp-for="YayindaMi">Yayında</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAĞ SÜTUN -->
                <div class="col-12 col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="card-header bg-white">
                            <strong>Vitrin / Öne Çıkarma</strong>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" asp-for="IsPopular" />
                                <label class="form-check-label" for="IsPopular">Popüler Ürün</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" asp-for="IsAvantajli" />
                                <label class="form-check-label" for="IsAvantajli">Avantajlı Ürün</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="IsSlider" />
                                <label class="form-check-label" for="IsSlider">Slider’da Göster</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" asp-for="IsCokSatan" />
                                <label class="form-check-label" for="IsCokSatan">Çok Satanlarda Göster</label>
                            </div>
                            <div class="form-text mt-2">
                                Bu alanları sadece <b>Admin</b> düzenleyebilir.
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm rounded-4 mt-3">
                        <div class="card-header bg-white">
                            <strong>Görsel</strong>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrWhiteSpace(Model?.ResimUrl))
                            {
                                <div class="mb-2">
                                    <img src="@Model.ResimUrl" alt="Ürün" class="img-fluid rounded" style="max-height:160px; object-fit:cover" />
                                </div>
                            }
                            <div class="mb-3">
                                <input type="file" name="YeniResim" class="form-control" accept="image/*" />
                                <div class="form-text">Yeni görsel yüklersen mevcut görsel güncellenir.</div>
                            </div>

                            @* === Ek Görseller (opsiyonel, çoklu) === *@
                            <div class="mb-2">
                                <label class="form-label">Ek Görseller (opsiyonel)</label>
                                <input type="file" name="EkResimler" id="EkResimler" class="form-control" accept="image/*" multiple />
                                <small class="text-muted d-block">Birden fazla görsel seçebilirsin (öneri: ≤ 6 adet, ≤ 5 MB).</small>
                                <div id="ekResimUyari" class="text-danger small mt-1" style="display:none;"></div>
                            </div>

                            @* Mevcut ek görsellerin küçük önizlemesi *@
                            @if (gallery.Any())
                            {
                                <div class="mb-2">
                                    <div class="small text-muted mb-1">Kayıtlı ek görseller:</div>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var g in gallery)
                                        {
                                            <div class="border rounded" style="width:82px;height:82px;overflow:hidden;">
                                                <img src="@g" alt="ek" style="width:100%;height:100%;object-fit:cover;" />
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            @* Yeni seçilenlerin canlı önizlemesi *@
                            <div id="ekResimPreview" class="d-flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div> <!--/row-->

            <div class="d-flex justify-content-end mt-4">
                <a asp-action="Index" class="btn btn-outline-secondary me-2">Geri</a>
                <button class="btn btn-dark">Kaydet</button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
          // --- FiyatAdmin normalize (12,50 -> 12.50) ---
          const form = document.getElementById('urunEditForm');
          if(form){
            form.addEventListener('submit', function(){
              const fiyatInput = form.querySelector('[name="FiyatAdmin"]');
              if(fiyatInput && typeof fiyatInput.value === 'string'){
                // boşlukları temizle, virgülü noktaya çevir
                fiyatInput.value = fiyatInput.value.trim().replace(',', '.');
              }
            }, {capture:true});
          }

          // --- Ek görsel önizleme ---
          const ekInput = document.getElementById('EkResimler');
          const preview = document.getElementById('ekResimPreview');
          const warn = document.getElementById('ekResimUyari');

          if(ekInput && preview){
            const MAX_FILES = 6;
            const MAX_MB = 5;

            function clearPreview(){
              preview.innerHTML = '';
              if(warn){ warn.style.display = 'none'; warn.textContent=''; }
            }

            function addThumb(file, objectUrl){
              const wrap = document.createElement('div');
              wrap.style.width = '82px';
              wrap.style.height = '82px';
              wrap.style.borderRadius = '10px';
              wrap.style.overflow = 'hidden';
              wrap.style.position = 'relative';
              wrap.style.boxShadow = '0 2px 8px rgba(0,0,0,.08)';

              const img = document.createElement('img');
              img.src = objectUrl;
              img.alt = file.name;
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.objectFit = 'cover';
              wrap.appendChild(img);

              preview.appendChild(wrap);
            }

            ekInput.addEventListener('change', function(){
              clearPreview();
              const files = Array.from(ekInput.files || []);
              if(files.length === 0) return;

              if(files.length > MAX_FILES && warn){
                warn.textContent = `En fazla ${MAX_FILES} görsel seçebilirsiniz. Seçilen: ${files.length}`;
                warn.style.display = 'block';
              }

              let showCount = 0;
              for(const f of files){
                if(!f.type.startsWith('image/')){
                  if(warn){ warn.textContent = 'Sadece resim dosyaları yükleyebilirsiniz.'; warn.style.display = 'block'; }
                  continue;
                }
                if(f.size > MAX_MB * 1024 * 1024){
                  if(warn){ warn.textContent = `Her dosya en fazla ${MAX_MB} MB olmalı: ${f.name}`; warn.style.display = 'block'; }
                  continue;
                }
                if(showCount >= MAX_FILES) continue;

                const url = URL.createObjectURL(f);
                addThumb(f, url);
                showCount++;
              }
            });
          }
        })();
    </script>
}
