@using AlisverisSitesiFinal.Models
@using AlisverisSitesiFinal.Helpers
@using Microsoft.AspNetCore.Identity
@model IEnumerable<SepetKalemi>
@inject UserManager<Kullanici> UserManager

@{
    ViewData["Title"] = "Sepetim";
    var user = await UserManager.GetUserAsync(User);

    decimal genelToplam = 0m;
    string FiyatStr(decimal v) => v.ToString("C0");
}

<style>
    :root {
        --ring: #e9eef5;
        --muted: #6b7280;
        --ink: #111827;
        --brand: #10b981; /* Maraline yeşili */
        --bg: #fafafa;
        --card: #ffffff;
        --shadow: 0 10px 30px rgba(17, 24, 39, .06);
        --softshadow: 0 4px 16px rgba(17, 24, 39, .05);
        --radius: 16px;
        --radius-sm: 12px;
    }

    .cart-page {
        padding: 10px 0 7rem;
        background: linear-gradient(180deg, #fff 0%, #fbfbfb 100%);
    }

    .page-head {
        padding: 8px 12px;
        border: 1px solid var(--ring);
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--softshadow);
    }

    .head-title {
        font-size: 1.05rem;
        font-weight: 800;
        letter-spacing: .2px;
        color: var(--ink);
    }

    .ghost-btn {
        background: #f6f7f9;
        border: 1px solid var(--ring);
        color: var(--ink);
        padding: 9px 12px;
        border-radius: 12px;
        font-weight: 600;
    }

        .ghost-btn:hover {
            background: #eef1f6;
        }

    /* UYARI BLOĞU (yalnızca bu eklendi) */
    .cart-alerts {
        margin-top: 12px;
    }

    .alert {
        border-radius: 12px;
        box-shadow: var(--softshadow);
        border: 1px solid var(--ring);
    }

        .alert + .alert {
            margin-top: 10px;
        }

    /* Kart */
    .cart-card {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 14px;
        padding: 14px;
        margin: 12px 0;
        border: 1px solid var(--ring);
        border-radius: var(--radius);
        background: var(--card);
        box-shadow: var(--softshadow);
    }

    .cart-img {
        width: 96px;
        height: 96px;
        border-radius: 14px;
        object-fit: cover;
        background: #f3f4f6;
        border: 1px solid #eef0f4;
    }

    .cart-title {
        font-weight: 700;
        line-height: 1.25;
        color: var(--ink);
        font-size: 15.5px;
        margin-bottom: 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .cart-variant {
        font-size: 12.5px;
        color: var(--muted);
        background: #f7f8fb;
        border: 1px dashed #e7ebf2;
        border-radius: 10px;
        padding: 6px 8px;
        margin-bottom: 8px;
    }

    .line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-top: 8px;
    }

    .unit {
        font-size: 12.5px;
        color: var(--muted);
    }

    .price {
        font-size: 15px;
        font-weight: 800;
        color: var(--ink);
        padding: 6px 10px;
        border-radius: 10px;
        background: #f9fafb;
        border: 1px solid #eef1f6;
    }

    /* Adet stepper */
    .qty-wrap {
        display: inline-flex;
        align-items: center;
        overflow: hidden;
        border: 1px solid var(--ring);
        border-radius: 12px;
        background: #fff;
        box-shadow: inset 0 0 0 1px #ffffff;
    }

    .qty-btn {
        width: 40px;
        height: 40px;
        display: grid;
        place-items: center;
        background: #f7f9fc;
        border: none;
        font-size: 18px;
        line-height: 1;
        font-weight: 800;
    }

        .qty-btn:active {
            transform: translateY(1px);
        }

    .qty-input {
        width: 56px;
        height: 40px;
        text-align: center;
        border: none;
        outline: none;
        font-weight: 700;
        color: var(--ink);
    }

    .rmv-btn {
        border: none;
        background: transparent;
        color: #ef4444;
        padding: 6px 8px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
    }

        .rmv-btn:hover {
            background: #fee2e2;
        }

    /* Sticky bar */
    .cart-sticky {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
        background: rgba(255,255,255,.86);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--ring);
        box-shadow: 0 -10px 30px rgba(17,24,39,.05);
    }

    .cart-sticky-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .sum {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
    }

        .sum .lbl {
            font-size: 12.5px;
            color: var(--muted);
        }

        .sum .val {
            font-size: 19px;
            font-weight: 900;
            letter-spacing: .2px;
        }

    .btn-primaryx {
        background: var(--brand);
        color: #fff;
        border: none;
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 800;
        box-shadow: 0 8px 20px rgba(16,185,129,.25);
    }

        .btn-primaryx:active {
            transform: translateY(1px);
        }

    .btn-secondaryx {
        background: #f1f3f5;
        color: #0f172a;
        border: 1px solid var(--ring);
        padding: 11px 14px;
        border-radius: 12px;
        font-weight: 700;
    }
</style>

<div class="container cart-page">
    <div class="page-head d-flex align-items-center justify-content-between mb-3">
        <div class="head-title">Sepetim</div>
        @if (Model?.Any() == true)
        {
            <form asp-action="TopluSil" method="post" class="m-0">
                <button type="submit" class="ghost-btn">Sepeti Boşalt</button>
            </form>
        }
    </div>

    <!-- Uyarıların Sepet sayfasında görünmesi için eklendi -->
    <div class="cart-alerts">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success" role="alert">@TempData["Success"]</div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger" role="alert">@TempData["Error"]</div>
        }
        @if (TempData["Warning"] != null)
        {
            <div class="alert alert-warning" role="alert">@TempData["Warning"]</div>
        }
        @if (TempData["Info"] != null)
        {
            <div class="alert alert-info" role="alert">@TempData["Info"]</div>
        }
    </div>
    <!-- /Uyarılar -->
    @if (Model == null || !Model.Any())
    {
        <div class="text-center py-5">
            <div class="mb-2" style="font-size:2rem">🧺</div>
            <div class="fw-semibold mb-2" style="color:var(--ink)">Sepetiniz boş</div>
            <a asp-controller="Uruns" asp-action="Index" class="btn-primaryx">Alışverişe Başla</a>
        </div>
    }
    else
    {
        foreach (var item in Model)
        {
            var birim = (decimal)(FiyatHelper.GetGorunecekFiyat(user, item.Urun!) ?? 0m);
            var satir = birim * item.Miktar;
            genelToplam += satir;

            <div class="cart-card">
                <img class="cart-img" src="@(item.Urun?.ResimUrl ?? "/img/no-image.png")" alt="@item.Urun?.Ad" />

                <div>
                    <div class="cart-title">@item.Urun?.Ad</div>
                    @if (!string.IsNullOrWhiteSpace(item.Aciklama))
                    {
                        <div class="cart-variant">@item.Aciklama</div>
                    }

                    <div class="line">
                        <div class="unit">Birim Fiyat: <strong>@FiyatStr(birim)</strong></div>
                        <form asp-action="SepettenSil" method="post" class="m-0">
                            <input type="hidden" name="id" value="@item.Id" />
                            <button class="rmv-btn" type="submit" title="Kaldır">Kaldır</button>
                        </form>
                    </div>

                    <div class="line">
                        <!-- Adet Stepper (tek endpoint: GuncelleMiktar) -->
                        <form asp-action="GuncelleMiktar" method="post" class="m-0 d-inline-flex align-items-center">
                            <input type="hidden" name="id" value="@item.Id" />
                            <div class="qty-wrap">
                                <button type="submit" class="qty-btn"
                                        onclick="this.form.yeniMiktar.value=Math.max(1, parseInt(this.form.yeniMiktar.value||'1')-1);"
                                        aria-label="Azalt">
                                    −
                                </button>
                                <input class="qty-input" name="yeniMiktar" value="@item.Miktar" inputmode="numeric" pattern="[0-9]*" aria-label="Miktar" />
                                <button type="submit" class="qty-btn"
                                        onclick="this.form.yeniMiktar.value=parseInt(this.form.yeniMiktar.value||'1')+1;"
                                        aria-label="Arttır">
                                    ＋
                                </button>
                            </div>
                        </form>

                        <div class="price">@FiyatStr(satir)</div>
                    </div>
                </div>
            </div>
        }

        <!-- Alt sticky toplam -->
        <div class="cart-sticky">
            <div class="cart-sticky-inner">
                <div class="sum">
                    <span class="lbl">Ara Toplam</span>
                    <span class="val">@FiyatStr(genelToplam)</span>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <a asp-controller="Uruns" asp-action="Index" class="btn-secondaryx">Alışverişe Devam</a>
                    <form asp-action="SepetiOnayla" method="post" class="m-0">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn-primaryx">Sepeti Onayla</button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>
