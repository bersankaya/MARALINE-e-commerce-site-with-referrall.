@model AlisverisSitesiFinal.Models.BenimReferanslarimViewModel
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Benim Referanslarım";
    var jsonTree = JsonConvert.SerializeObject(Model.ReferralTreeRoot);

    var refCode = Model.Kullanici.ReferansKodu;

    // Razor Pages (Identity) için doğru, mutlak URL:
    var inviteUrl = Url.Page(
        pageName: "/Account/Register",
        pageHandler: null,
        values: new { area = "Identity", @ref = refCode },   // @ref önemli
        protocol: Context.Request.Scheme                      // https veya http
    );
}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
</head>
<style>
    .tree-wrapper {
        overflow-x: auto;
        padding: 20px;
    }

    .node {
        position: relative;
        padding: 10px 16px;
        border-radius: 8px;
        background-color: #e2f0d9;
        border: 1px solid #bcd9b3;
        min-width: 160px;
        font-weight: 500;
        margin-bottom: 10px;
    }

        .node.pasif {
            background-color: #f8d7da;
            border-color: #f5c2c7;
            color: #842029;
        }

    .children {
        margin-left: 30px;
        border-left: 2px dashed #ccc;
        padding-left: 20px;
        display: none;
    }

    .toggle {
        cursor: pointer;
        font-size: .9rem;
        color: #0d6efd;
    }

        .toggle:hover {
            text-decoration: underline;
        }

    .info-card .card-body p {
        margin-bottom: .4rem;
        font-size: 1rem;
    }

    .info-label {
        color: #6c757d;
        font-weight: 500;
    }

    .copy-input {
        user-select: all;
    }

    .btn-round {
        border-radius: 999px;
    }

    .share-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .copy-toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 18px;
        background: #198754;
        color: #fff;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: .9rem;
        box-shadow: 0 6px 24px rgba(0,0,0,.15);
        opacity: 0;
        transition: .25s ease;
        z-index: 9999;
    }

        .copy-toast.show {
            opacity: 1;
        }
</style>
<style type="text/css">
    @@media (max-width: 768px) {
        .node {
            font-size: 0.8rem;
        }
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-people-fill"></i> Benim Referanslarım
    </h2>

    <!-- Kullanıcı Kartı + Ref Kodu -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="row g-0 align-items-center">
            <div class="col-auto p-4">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 70px; height: 70px; font-size: 30px;">
                    <i class="bi bi-person-fill"></i>
                </div>
            </div>
            <div class="col-md p-3">
                <h5 class="mb-2 text-dark">Kullanıcı Bilgileri</h5>
                <p class="mb-1">
                    <span class="text-muted">Ad Soyad:</span>
                    <strong>@Model.Kullanici.Ad @Model.Kullanici.Soyad</strong>
                </p>

                <div class="mb-2">
                    <span class="text-muted">Referans Kodunuz:</span>
                    <div class="input-group mt-1" style="max-width: 420px;">
                        <input id="refCodeInput" class="form-control copy-input" value="@refCode" readonly />
                        <button type="button" class="btn btn-outline-secondary" title="Kodu kopyala" onclick="copyText('#refCodeInput')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>

                </div>

                <div class="mt-3">
                    <div class="text-muted mb-1">Kazanmak için davet et:</div>
                    <div class="input-group" style="max-width: 640px;">
                        <input id="inviteLinkInput" class="form-control copy-input" value="@inviteUrl" readonly />
                        <button type="button" class="btn btn-outline-secondary" title="Davet linkini kopyala" onclick="copyText('#inviteLinkInput')">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary" title="Paylaş (telefon)" onclick="shareInvite('@inviteUrl')">
                            <i class="bi bi-share-fill"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2 mt-2 flex-wrap">
                        <a class="btn btn-light border share-btn btn-round"
                           href="https://wa.me/?text=@Uri.EscapeDataString($"Sana özel davet: {inviteUrl}")"
                           target="_blank" rel="noopener">
                            <i class="bi bi-whatsapp"></i> WhatsApp
                        </a>
                        <a class="btn btn-light border share-btn btn-round"
                           href="https://t.me/share/url?url=@Uri.EscapeDataString(inviteUrl!)&text=@Uri.EscapeDataString("Sana özel davet!")"
                           target="_blank" rel="noopener">
                            <i class="bi bi-telegram"></i> Telegram
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referans Soy Ağacı -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header fw-semibold">
            <i class="bi bi-diagram-3"></i> Referans Soy Ağacı (Yatay + Açılır)
        </div>
        <div class="card-body tree-wrapper">
            <div id="treeContainer"></div>
        </div>
    </div>

    @if (Model.BonusLoglar != null && Model.BonusLoglar.Any())
    {
        <div class="card shadow-sm mb-5">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Bonus Geçmişi</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-bordered table-striped mb-0">
                    <thead class="table-light">
                        <tr><th>Tarih</th><th>Tutar</th><th>Açıklama</th></tr>
                    </thead>
                    <tbody>
                        @foreach (var bonus in Model.BonusLoglar)
                        {
                            var aciklama = bonus.Aciklama;
                            var guidIndex = aciklama.LastIndexOf(" - ");
                            if (guidIndex > 0) { aciklama = aciklama.Substring(0, guidIndex); }
                            <tr>
                                <td>@bonus.Tarih.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@bonus.Tutar.ToString("C")</td>
                                <td>@aciklama</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">Henüz bonus kazancınız bulunmamaktadır.</div>
    }
</div>

<script id="refData" type="application/json">
    @Html.Raw(jsonTree)
</script>

<div id="copyToast" class="copy-toast">Kopyalandı</div>

@section Scripts {
    <script>
        // Modern Clipboard API ile kopyalama
        async function copyText(selector){
            try{
                const el = document.querySelector(selector);
                const val = (el && ('value' in el)) ? el.value : (el?.textContent ?? '');
                if (!val) { showCopied(); return; }

                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(val);
                    showCopied();
                } else {
                    if (el && 'select' in el) { el.select(); el.setSelectionRange?.(0, 99999); }
                    showCopied();
                }
            } catch { showCopied(); }
        }

        function showCopied(){
            const t = document.getElementById('copyToast');
            if(!t) return;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1200);
        }

        // Native Share (varsa). Yoksa linki Clipboard API ile kopyalıyoruz.
        async function shareInvite(url){
            const text = "Sana özel davet!";
            if (navigator.share){
                try { await navigator.share({ title: document.title, text, url }); } catch {}
                return;
            }
            if (navigator.clipboard && window.isSecureContext){
                try { await navigator.clipboard.writeText(url); showCopied(); return; } catch {}
            }
            const tmp = document.getElementById('inviteLinkInput');
            if (tmp && 'select' in tmp) { tmp.select(); tmp.setSelectionRange?.(0, 99999); }
            showCopied();
        }

        // Ağaç
        function renderTree(node) {
            const nodeClass = node.AktifMi ? "" : "pasif";
            let html = `<div class="node ${nodeClass}">
                <i class="bi ${node.AktifMi ? 'bi-person-check-fill text-success' : 'bi-person-x-fill text-secondary'}"></i>
                ${node.AdSoyad} <small>(${node.KayitTarihi})</small>
            </div>`;
            if (node.Cocuklar && node.Cocuklar.length > 0) {
                html += `<div class="toggle" onclick="toggleVisibility(this)">+ Alt Referansları Göster</div>`;
                html += `<div class="children">`;
                for (const child of node.Cocuklar) { html += renderTree(child); }
                html += `</div>`;
            }
            return html;
        }
        function toggleVisibility(element) {
            const next = element.nextElementSibling;
            if (next.style.display === "none" || next.style.display === "") {
                next.style.display = "block"; element.textContent = "− Alt Referansları Gizle";
            } else {
                next.style.display = "none"; element.textContent = "+ Alt Referansları Göster";
            }
        }
        document.addEventListener("DOMContentLoaded", function () {
            const rawJson = document.getElementById("refData").textContent;
            try {
                const treeData = JSON.parse(rawJson);
                const htmlTree = renderTree(treeData);
                document.getElementById("treeContainer").innerHTML = htmlTree;
            } catch (e) {
                document.getElementById("treeContainer").innerHTML =
                    "<div class='text-danger'>Veri okunamadı.</div>";
                console.error("JSON parse hatası:", e);
            }
        });

        // (Bilgilendirme) Otomatik doldurma için Register sayfasında kullanılacak çerez anahtarı:
        // maraline_ref -> referans kodu. Bu sayfa, paylaşan kullanıcı tarafında sadece bilgilendirici.
    </script>
}
