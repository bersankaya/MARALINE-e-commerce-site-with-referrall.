@page
@model SetPasswordModel
@{
    ViewData["Title"] = "Şifre Oluştur";
    ViewData["ActivePage"] = ManageNavPages.ChangePassword;
}

<partial name="_StatusMessage" for="StatusMessage" />

<div class="container py-3 py-md-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">

            <div class="card border-0 shadow-sm" style="border-radius:1rem;">
                <div class="card-body p-4 p-md-5">

                    <!-- Başlık -->
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                             style="width:52px;height:52px;background:#e7f1ff;">
                            <!-- kilit simgesi -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#0d6efd" viewBox="0 0 16 16" aria-hidden="true">
                                <path d="M8 1a3 3 0 0 0-3 3v2H4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-1V4a3 3 0 0 0-3-3zm2 5H6V4a2 2 0 1 1 4 0z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="h4 mb-0">Şifrenizi Belirleyin</h1>
                            <div class="text-muted small">Harici girişe gerek kalmadan hesabınıza giriş yapın</div>
                        </div>
                    </div>

                    <div class="alert alert-info d-flex align-items-start gap-2" role="alert">
                        <span class="mt-1" aria-hidden="true">ℹ️</span>
                        <div>
                            Bu sitede şu an yerel bir şifreniz yok. Aşağıdan yeni bir şifre oluşturarak
                            e-posta + şifre ile giriş yapabilirsiniz.
                        </div>
                    </div>

                    <form id="set-password-form" method="post" class="mt-3" novalidate>
                        <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

                        <!-- Yeni Şifre -->
                        <div class="mb-3">
                            <label asp-for="Input.NewPassword" class="form-label fw-semibold">Yeni Şifre</label>
                            <div class="input-group">
                                <input asp-for="Input.NewPassword"
                                       class="form-control"
                                       autocomplete="new-password"
                                       aria-required="true"
                                       placeholder="Yeni şifrenizi girin"
                                       id="newPassword" />
                                <button type="button" class="btn btn-outline-secondary" id="toggleNewPwd" aria-label="Şifreyi göster/gizle">
                                    <!-- göz ikonu -->
                                    <svg id="eyeNew" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8z" />
                                        <path d="M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="form-text">
                                En az 6 karakter; daha güçlü bir şifre için büyük/küçük harf, rakam ve sembol kullanın.
                            </div>
                            <span asp-validation-for="Input.NewPassword" class="text-danger"></span>

                            <!-- Güç göstergesi -->
                            <div class="progress mt-2" style="height:8px;" aria-hidden="true">
                                <div class="progress-bar" id="pwdBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="small mt-1" id="pwdHint"></div>
                        </div>

                        <!-- Yeni Şifre (Tekrar) -->
                        <div class="mb-3">
                            <label asp-for="Input.ConfirmPassword" class="form-label fw-semibold">Yeni Şifre (Tekrar)</label>
                            <div class="input-group">
                                <input asp-for="Input.ConfirmPassword"
                                       class="form-control"
                                       autocomplete="new-password"
                                       aria-required="true"
                                       placeholder="Yeni şifrenizi tekrar girin"
                                       id="confirmPassword" />
                                <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPwd" aria-label="Şifreyi göster/gizle">
                                    <svg id="eyeConfirm" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8z" />
                                        <path d="M8 5.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5z" />
                                    </svg>
                                </button>
                            </div>
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                            <div class="form-text" id="matchText"></div>
                        </div>

                        <!-- Aksiyonlar -->
                        <div class="d-flex flex-column flex-md-row gap-2">
                            <button type="submit" class="btn btn-primary btn-lg px-4">Şifreyi Oluştur</button>
                            <a asp-page="./Index" class="btn btn-outline-secondary btn-lg px-4">Hesap Ayarlarına Dön</a>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            // Şifre Göster/Gizle
            function toggleVisibility(btnId, inputId, eyeId) {
                const btn = document.getElementById(btnId);
                const input = document.getElementById(inputId);
                const eye = document.getElementById(eyeId);
                if (!btn || !input) return;
                btn.addEventListener('click', function () {
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    // basit göz/çizgi değişimi (ikon sabit; istersen çizgili ikon ekleyebilirsin)
                    eye.style.opacity = (type === 'text') ? '0.7' : '1';
                });
            }
            toggleVisibility('toggleNewPwd', 'newPassword', 'eyeNew');
            toggleVisibility('toggleConfirmPwd', 'confirmPassword', 'eyeConfirm');

            // Güç Göstergesi
            const pwd = document.getElementById('newPassword');
            const bar = document.getElementById('pwdBar');
            const hint = document.getElementById('pwdHint');
            const matchText = document.getElementById('matchText');
            const confirm = document.getElementById('confirmPassword');

            function scorePassword(v) {
                let s = 0;
                if (!v) return 0;
                if (v.length >= 6) s += 20;
                if (v.length >= 10) s += 10;
                if (/[a-z]/.test(v)) s += 20;
                if (/[A-Z]/.test(v)) s += 20;
                if (/\d/.test(v)) s += 20;
                if (/[^A-Za-z0-9]/.test(v)) s += 10;
                return Math.min(s, 100);
            }

            function setStrength(p) {
                bar.style.width = p + '%';
                bar.classList.remove('bg-danger','bg-warning','bg-success');
                if (p < 40) {
                    bar.classList.add('bg-danger');
                    hint.textContent = 'Zayıf şifre';
                } else if (p < 70) {
                    bar.classList.add('bg-warning');
                    hint.textContent = 'Orta seviye şifre';
                } else {
                    bar.classList.add('bg-success');
                    hint.textContent = 'Güçlü şifre';
                }
            }

            function checkMatch() {
                if (!confirm.value) {
                    matchText.textContent = '';
                    return;
                }
                matchText.textContent = (pwd.value === confirm.value)
                    ? '✔ Şifreler eşleşiyor'
                    : '✘ Şifreler eşleşmiyor';
                matchText.classList.toggle('text-success', pwd.value === confirm.value);
                matchText.classList.toggle('text-danger', pwd.value !== confirm.value);
            }

            if (pwd) {
                pwd.addEventListener('input', function () {
                    setStrength(scorePassword(pwd.value));
                    checkMatch();
                });
            }
            if (confirm) {
                confirm.addEventListener('input', checkMatch);
            }

            // İlk durum
            setStrength(0);
        })();
    </script>
}
