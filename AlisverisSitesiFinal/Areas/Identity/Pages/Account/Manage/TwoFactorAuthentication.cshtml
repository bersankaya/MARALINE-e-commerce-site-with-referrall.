@page
@using Microsoft.AspNetCore.Http.Features
@model TwoFactorAuthenticationModel
@{
    ViewData["Title"] = "İki Aşamalı Doğrulama (2FA)";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
}

<partial name="_StatusMessage" for="StatusMessage" />

<div class="container py-3 py-md-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-9">

            <div class="card border-0 shadow-sm" style="border-radius:1rem;">
                <div class="card-body p-4 p-md-5">

                    <!-- Başlık -->
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                                 style="width:52px;height:52px;background:#e7f1ff;">
                                <!-- 2FA kalkan simgesi -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#0d6efd" viewBox="0 0 16 16" aria-hidden="true">
                                    <path d="M5.5 0a.5.5 0 0 0-.276.084l-4 2.667A.5.5 0 0 0 1 3.167V6c0 5.255 3.663 8.323 6.293 9.67a.5.5 0 0 0 .414 0C10.337 14.323 14 11.255 14 6V3.167a.5.5 0 0 0-.224-.416l-4-2.667A.5.5 0 0 0 9.5 0h-4z" />
                                    <path d="M6.5 10.5l-2-2 .708-.708L6.5 9.086l4.292-4.292.708.708-5 5z" />
                                </svg>
                            </div>
                            <div>
                                <h1 class="h4 mb-0">@ViewData["Title"]</h1>
                                <div class="text-muted small">Hesap güvenliği • 2FA durum ve ayarlar</div>
                            </div>
                        </div>

                        <!-- Durum Rozetleri -->
                        <div class="d-flex flex-wrap gap-2">
                            @if (Model.Is2faEnabled)
                            {
                                <span class="badge bg-success">2FA Etkin</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">2FA Kapalı</span>
                            }

                            @if (Model.IsMachineRemembered)
                            {
                                <span class="badge bg-info text-dark" title="Bu tarayıcı 2FA istemez">Tarayıcı Tanınıyor</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-muted border">Tarayıcı Tanınmıyor</span>
                            }

                            @if (Model.HasAuthenticator)
                            {
                                <span class="badge bg-primary">Authenticator Kurulu</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Authenticator Yok</span>
                            }
                        </div>
                    </div>

                    @{
                        var consentFeature = HttpContext.Features.Get<ITrackingConsentFeature>();
                        if (consentFeature?.CanTrack ?? true)
                        {
                            if (Model.Is2faEnabled)
                            {
                                if (Model.RecoveryCodesLeft == 0)
                                {
                                    <div class="alert alert-danger" role="alert">
                                        <strong>Kalan kurtarma kodunuz yok.</strong>
                                        <p class="mb-0">
                                            Girişte kurtarma kodu kullanabilmek için
                                            <a asp-page="./GenerateRecoveryCodes" class="alert-link">yeni bir kurtarma kodları kümesi oluşturun</a>.
                                        </p>
                                    </div>
                                }
                                else if (Model.RecoveryCodesLeft == 1)
                                {
                                    <div class="alert alert-danger" role="alert">
                                        <strong>Yalnızca 1 kurtarma kodunuz kaldı.</strong>
                                        <p class="mb-0">
                                            Hemen <a asp-page="./GenerateRecoveryCodes" class="alert-link">yeni bir kurtarma kodları kümesi oluşturun</a>.
                                        </p>
                                    </div>
                                }
                                else if (Model.RecoveryCodesLeft <= 3)
                                {
                                    <div class="alert alert-warning" role="alert">
                                        <strong>@Model.RecoveryCodesLeft adet kurtarma kodunuz kaldı.</strong>
                                        <p class="mb-0">
                                            <a asp-page="./GenerateRecoveryCodes" class="alert-link">Yeni bir küme oluşturmanız</a> önerilir.
                                        </p>
                                    </div>
                                }

                                <!-- Tarayıcıyı Unut / 2FA'yı Kapat / Kodları Yenile -->
                                <div class="d-flex flex-wrap gap-2 mb-4">
                                    @if (Model.IsMachineRemembered)
                                    {
                                        <form method="post" asp-page-handler="ForgetBrowser" class="d-inline">
                                            <button type="submit" class="btn btn-outline-secondary">
                                                Bu Tarayıcıyı Unut
                                            </button>
                                        </form>
                                    }
                                    <a asp-page="./Disable2fa" class="btn btn-outline-danger">2FA’yı Devre Dışı Bırak</a>
                                    <a asp-page="./GenerateRecoveryCodes" class="btn btn-outline-primary">Kurtarma Kodlarını Yenile</a>
                                </div>
                            }

                            <!-- Authenticator Uygulaması Bölümü -->
                            <div class="mb-2">
                                <h5 class="fw-semibold">Kimlik Doğrulayıcı Uygulaması</h5>
                                <p class="text-muted small mb-3">
                                    Microsoft/Google Authenticator gibi bir uygulama ile 6 haneli kod üretip girişlerinizi güçlendirebilirsiniz.
                                </p>

                                @if (!Model.HasAuthenticator)
                                {
                                    <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn btn-primary">
                                        Doğrulayıcı Uygulama Ekle
                                    </a>
                                }
                                else
                                {
                                    <div class="d-flex flex-wrap gap-2">
                                        <a id="enable-authenticator" asp-page="./EnableAuthenticator" class="btn btn-primary">
                                            Doğrulayıcı Uygulamayı Kur
                                        </a>
                                        <a id="reset-authenticator" asp-page="./ResetAuthenticator" class="btn btn-outline-danger">
                                            Doğrulayıcı Anahtarını Sıfırla
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger" role="alert">
                                <strong>Gizlilik ve çerez politikası kabul edilmedi.</strong>
                                <p class="mb-0">2FA’yı etkinleştirebilmek için önce politikayı kabul etmeniz gerekir.</p>
                            </div>
                        }
                    }

                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
