@page
@model AlisverisSitesiFinal.Areas.Identity.Pages.Account.RegisterModel
@{
    ViewData["Title"] = "Kayıt Ol";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

<div class="odeme-banner odeme-banner--warn" role="note" aria-label="Uyarı">
    <i class="bi bi-exclamation-circle-fill"></i>
    <div class="odeme-banner-body">
        <p>Bir Referansınız Yoksa Referans Kodu Kısmına MARA200 Yazarak Üye Olabilrsiniz.</p>
    </div>
</div>

<h2 class="mb-4 fw-bold text-primary text-center">@ViewData["Title"]</h2>

<style>
    /* Zarif dokunuşlar */
    .auth-card {
        border: 0;
        border-radius: 1rem;
    }

        .auth-card .card-body {
            padding: 2rem;
        }

    .form-control, .btn {
        border-radius: .8rem;
    }

    .form-label {
        font-weight: 600;
    }

    .form-text {
        font-size: .85rem;
    }

    .btn-primary, .btn-dark {
        padding: .7rem 1rem;
        font-weight: 600;
    }

    .hint-muted {
        color: #6c757d;
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <div class="card shadow-sm auth-card">
                <div class="card-body">
                    <h1 class="h4 mb-1 text-center fw-bold">Hesap Oluştur</h1>
                    <p class="text-center text-muted mb-4">Dakikalar içinde alışverişe başlayın</p>

                    @* Sunucu tarafı hataları üstte tek kutuda göster (TempData debug dökümü dahil) *@
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger rounded-3">@Html.Raw(TempData["ErrorMessage"])</div>
                    }

                    <!-- Genel doğrulama özeti -->
                    <div asp-validation-summary="ModelOnly" class="text-danger small mb-2"></div>

                    <form method="post" asp-route-returnUrl="@Model.ReturnUrl" novalidate>
                        @Html.AntiForgeryToken()

                        <div class="row g-3">
                            <div class="col-12 col-sm-6">
                                <label asp-for="Input.Ad" class="form-label"></label>
                                <input asp-for="Input.Ad" class="form-control" placeholder="Adınız" />
                                <span asp-validation-for="Input.Ad" class="text-danger small"></span>
                            </div>

                            <div class="col-12 col-sm-6">
                                <label asp-for="Input.Soyad" class="form-label"></label>
                                <input asp-for="Input.Soyad" class="form-control" placeholder="Soyadınız" />
                                <span asp-validation-for="Input.Soyad" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Input.Email" class="form-label"></label>
                                <input asp-for="Input.Email" class="form-control" inputmode="email" autocomplete="email" placeholder="ornek@mail.com" />
                                <span asp-validation-for="Input.Email" class="text-danger small"></span>
                                <div class="form-text hint-muted">E-posta benzersiz olmalıdır.</div>
                            </div>
                            <!-- ✨ E-posta tekrar -->
                            <div class="mb-3">
                                <label asp-for="Input.EmailConfirm" class="form-label"></label>
                                <input asp-for="Input.EmailConfirm" class="form-control" placeholder="ornek@mail.com" />
                                <span asp-validation-for="Input.EmailConfirm" class="text-danger"></span>
                                <div class="form-text hint-muted">E-posta benzersiz olmalıdır.</div>

                            </div>
                            @* ✅ TC Kimlik No alanı eklendi *@
                           @*  <div class="col-12">
                                <label asp-for="Input.TcKimlikNo" class="form-label"></label>
                                <input asp-for="Input.TcKimlikNo"
                                       class="form-control"
                                       maxlength="11"
                                       inputmode="numeric"
                                       placeholder="TC Kimlik Numaranız" />
                                <span asp-validation-for="Input.TcKimlikNo" class="text-danger small"></span>
                                <div class="form-text hint-muted">11 haneli olmalı; algoritma doğrulaması yapılır.</div>
                            </div>
                            <div class="col-12">
                                <label asp-for="Input.BirthYear" class="form-label"></label>
                                <input asp-for="Input.BirthYear"
                                       class="form-control"
                                       inputmode="numeric"
                                       placeholder="Doğum Yılı (YYYY)" />
                                <span asp-validation-for="Input.BirthYear" class="text-danger small"></span>
                                <div class="form-text hint-muted">TCKN doğrulaması için Ad, Soyad ve Doğum Yılı kullanılacaktır.</div>
                            </div> *@


                            <div class="col-12">
                                <label asp-for="Input.PhoneNumber" class="form-label"></label>
                                <input asp-for="Input.PhoneNumber"
                                       class="form-control"
                                       inputmode="numeric"
                                       autocomplete="tel"
                                       placeholder="05XXXXXXXXX"
                                       pattern="^(?:\+90|0)?5\d{9}$" />
                                <span asp-validation-for="Input.PhoneNumber" class="text-danger small"></span>
                                <div class="form-text hint-muted">Sadece Türk GSM numarası kabul edilir (ör: 05XXXXXXXXX).</div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <label asp-for="Input.Password" class="form-label">Şifre</label>
                                <input asp-for="Input.Password" class="form-control" autocomplete="new-password" placeholder="Şifre" />
                                <span asp-validation-for="Input.Password" class="text-danger small"></span>
                            </div>


                            <div class="col-12 col-sm-6">
                                <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                                <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" placeholder="Şifreyi tekrar" />
                                <span asp-validation-for="Input.ConfirmPassword" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="Input.ReferralCode" class="form-label"></label>
                                <input asp-for="Input.ReferralCode"
                                       class="form-control"
                                       maxlength="12"
                                       style="text-transform:uppercase"
                                       placeholder="REFERANS KODU"
                                       value="@(Request.Query["ref"].FirstOrDefault() ?? "")" />
                                <span asp-validation-for="Input.ReferralCode" class="text-danger small"></span>
                                <div class="form-text hint-muted">Referans kodu aktif ve geçerli olmalıdır.</div>
                            </div>
                        </div>
                        <div class="form-check my-3">
                            <input class="form-check-input" asp-for="Input.AcceptTerms" />
                            <label class="form-check-label" asp-for="Input.AcceptTerms"></label>
                            <a class="ms-1" target="_blank" rel="noopener" href="/dosyalar/Maraline_Kullanici_Sozlesmesi_ve_BonusPolitikasi1.pdf">
                                (Sözleşmeyi oku)
                            </a>
                        </div>
                        <span class="text-danger" asp-validation-for="Input.AcceptTerms"></span>

                        <button class="btn btn-dark w-100 mt-4">Kayıt Ol</button>

                        <div class="text-center mt-3">
                            <small class="text-muted">Zaten üye misiniz? <a asp-page="./Login">Giriş yap</a></small>
                        </div>
                    </form>
                </div>
            </div>

            <p class="text-center text-muted mt-3 small">
                Kayıt olarak <a href="/Home/Gizlilik">Gizlilik</a> ve <a href="/Home/MesafeliSatis">Şartlar</a>'ı kabul etmiş olursunuz.
            </p>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            // URL parametresi oku
            function getParam(name) {
                try {
                    const url = new URL(window.location.href);
                    return url.searchParams.get(name);
                } catch { return null; }
            }
            // Basit çerez yardımcıları
            function setCookie(n, v, days) {
                const d = new Date(); d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = n + "=" + encodeURIComponent(v) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
            }
            function getCookie(n) {
                const m = document.cookie.match(new RegExp("(^| )" + n + "=([^;]+)"));
                return m ? decodeURIComponent(m[2]) : null;
            }

            const urlRef = getParam("ref");
            if (urlRef) setCookie("maraline_ref", urlRef, 30);

            const input = document.getElementById("Input_ReferralCode")
                        || document.querySelector("[name='Input.ReferralCode']")
                        || document.getElementById("ReferralCode")
                        || document.querySelector("[name='ReferralCode']");

            if (input) {
                // Eğer boşsa URL ya da çerezden doldur
                if (!input.value || input.value.trim() === "") {
                    const val = urlRef || getCookie("maraline_ref");
                    if (val) input.value = val;
                }
                // Her ihtimale karşı büyük harfe çevir
                input.addEventListener("input", function () {
                    this.value = (this.value || "").toUpperCase();
                });
                // Sayfa ilk açıldığında da normalize et
                input.value = (input.value || "").toUpperCase();
            }
        })();
    </script>
}
